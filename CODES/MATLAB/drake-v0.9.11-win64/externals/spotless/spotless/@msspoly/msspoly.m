classdef (InferiorClasses = {?double}) msspoly
    properties 
        % Developer's Notes about Internal Representation:
        % 
        % Currently a sparse matrix representation is used.
        %
        % A large table is stored with unique rows for the distinct
        % monomials appearing in any matrix term.
        %
        %  e.g. for [ 2*x*y^3  0  x^7]
        %
        %  dim = [ 1 3 ]
        %  sub = [ 1 1 ; 1 3 ]
        %  vars = [ id(x) id(y) ; id(x) emptyid ]
        %  pow = [ 1 3 ; 7 0]
        %  coeff = [ 2 ; 1]
        %
        %  Though there is a canonical sorting for these entries not
        %  representend in this example.
        
        
        % Dimensions are stored here: dim == [numrow numcol]
        dim = [ 0 0 ];
        
        % E denotes the number of non-zero matrix entries.
        % v maximum number of variables appearing in any term.
        
        % Subscripts are E-by-2, sub(i,:) = [ rowno colno ] 
        % rows should be unique and 1 <= rowno <= numrow
        sub = zeros(0,2); 
        
        % Variables
        % E-by-v  where v is the maximal number of variables in any
        % term. The elements indicate the "id number" for variables
        % with a set aside id number for "no variable".
        var = zeros(0,1);
        
        % Powers
        % E-by-v list of non-negative integer powers for each variable.
        pow = zeros(0,1);
        
        % Conjugation
        % E-by-v list of variables which have been conjugated.
        cnj = zeros(0,1);
        
        % Coeff
        % E-by-1 list of complex coefficients appearing in any variable.
        coeff = zeros(0,1);
    end
    
    
    
    
    methods
        function p=msspoly(x,y,z,a,b)
            switch nargin,
              case 0,
              case 1,
                switch class(x),
                  case 'msspoly',
                    p = x;
                  case 'double',
                    if any(isnan(x(:)) | isinf(x(:)))
                        error('infinite coefficients not permitted');
                    end
                    p.dim = size(x);
                    [ii,jj,cc]=find(x);
                    p.sub = [ii(:) jj(:)];
                    p.var = zeros(size(p.sub,1),0);
                    p.pow = zeros(size(p.sub,1),0);
                    p.coeff = cc(:); 
                    p = p.make_canonical();
                  case 'char',
                    p = msspoly(x,1);
                  otherwise
                    error(['conversion of ' class(x) ' to msspoly not supported'])
                end
              case 2,
                if ~msspoly.isName(x)
                    error( ['Variable names must match n or Tn where n ' ...
                            'is a string, length(n) in 1:' ...
                            num2str(msspoly.nameLength) ...
                            ' and n(i) in ' msspoly.nameChars]);
                end
                if ~isa(y,'double') || ...
                        length(y) < 1 || ...
                        length(y) > 2
                    error(['2nd argument must be a double of length ' ...
                           'one or two.']); 
                end
                y=max(0,round(y(:)'));  % ERROR SUPRESSED: fix me
                m = y(1);
                if length(y) == 1, y(2) = 0; end
                p.dim = [ m 1 ];
                p.sub = [ (1:m)' ones(m,1) ];
                p.pow = ones(m,1);
                p.coeff = ones(m,1);                
                p.var = msspoly.name_to_id(x,y(2)+(1:y(1))'-1);
              case 5,
                p.dim = full(x);
                p.sub = full(y);
                p.var = full(z);
                p.pow = full(a);
                p.coeff = full(b);
                p = p.make_canonical();
              otherwise,
                error('Unsupported arguments.');
            end
            
            [flg,emsg] = check_canonical(p);
            if flg, error(emsg); end
        end
        
        function y = det(x)
          if ~isequal(size(size(x)), [1 2]) || size(x,1) ~= size(x,2)
            error('Must be a square matrix to compute determinant')
          end
          n = size(x,1);
          sigma = perms(1:n);
          I = eye(n);
          y = det(I(:,sigma(1,:)))*prod(diag(x.indexinto(1:n,sigma(1,:))));
          for i=2:size(sigma,1),
            y = y + det(I(:,sigma(i,:)))*prod(diag(x.indexinto(1:n,sigma(i,:))));
          end
        end
        
        function y = prod(x)
          if min(size(x)) == 1,
            y = x.indexinto(1);
            for i=2:length(x),
              y = y * x.indexinto(i);
            end
          else
            error('Prod not implemented for matrices yet');
          end
        end
        
        function y = adjugate(x)
          if ~isequal(size(size(x)), [1 2]) || size(x,1) ~= size(x,2)
            error('Must be a square matrix to compute adjugate')
          end
          n = size(x,1);
          y = zeros(n,n)*x.indexinto(1,1);
          s.type = '()';
          for i=1:n,
            for j=1:n,
              s.subs = {j, i};
              y = subsasgn(y,s,(-1)^(i+j)*det(x.indexinto([1:i-1 i+1:n],[1:j-1 j+1:n])));
            end
          end
        end
    end
    
    methods (Static)
        
        function p = zeros(sz,m)
            if nargin == 2
                sz = [sz m];
            end
            if ~spot_hasSize(sz,[1 2])
                error('Argument must be 1-by-2');
            elseif ~spot_isIntGE(sz,0)
                error('Argument must be non-negative integers');
            end
            
            p = msspoly(sz,zeros(0,2),zeros(0,1),zeros(0,1),zeros(0,1));
        end
        
    end
    
    methods (Static)
        function [b,xn] = isfreemsspoly(y)
            if ~isa(y,'msspoly'), 
                b = 0; 
                xn = []; 
            else
                [b,xn] = isfree(y);
            end
                
        end
        
        
        function [s1,s2] = padZeros(s1,s2)
            m1 = size(s1,2);
            m2 = size(s2,2);
            
            if m1 > m2
                s2 = [s2 zeros(size(s2,1),m1-m2)];
            elseif m2 > m1
                s1 = [s1 zeros(size(s1,1),m2-m1)];
            end
        end
        
        function ik = relate(x,y)
        %  ik = relate(x,y)
        %
        %  ik is N-by-2 where each the rows ik(j,:) = [ i k]  correspond
        %               to the pairs of indices with x(i) == y(k).
        %
        %  Throws an error if x or y cannot be cast to a double.
            x=full(double(x(:)));
            y=full(double(y(:)));

            mx=length(x);
            my=length(y);
            if mx*my==0, 
                ik=[]; 
            else
                m=mx+my;
                g=sortrows([[x  -(1:mx)'];[y (1:my)']]);
                g=[[g(1:m-1,1)==g(2:m,1);0] g(:,2)];
                ik=spot_gset(g);
            end
        end
        
% User facing name check.

        function ch = nameChars(idx)
            ch = ['@#_.' 'a'+(0:25)];
            
            if nargin > 0, ch = ch(idx); end
        end
        function l = nameLength()
            l = 4;
        end
        
        function mnp = maxNamePart()
            mnp = (length(msspoly.nameChars)+1).^(msspoly.nameLength);
        end

        function f = isName(ch)
            if isempty(ch) || ~ischar(ch)
                f = 0;
            elseif ch(1) == 'T'
                f = msspoly.isName(ch(2:end));
            else
                f = length(ch) <= msspoly.nameLength && ...
                    all(mss_match(msspoly.nameChars,ch)>0);
            end
            
        end
        
        function msk = isTrigId(vs)
            msk = logical(mod(vs,2));% == 1;
        end
        
        function n=name_to_id(ch,m)
            if (length(ch) > 1 & ch(1) == 'T')
                trigFlag = 1;
                ch = ch(2:end);
            else
                trigFlag = 0;
            end
            % This line copy pasted in id_to_name :\
            exponents = (length(msspoly.nameChars)+1).^(length(ch)-1:-1:0);
            namePart = sum(exp                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               